#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "libchem.h"

#define EPS 1e-8

#define M 10
#define N 15
#define O 20

/*
 * Test matrices for matrix multiplication.
 * C = A x B
 */
double A[M][N] = {{5 , 39, 36, 30, 78, 38, 31, 93, 27, 27, 55, 89, 66, 75, 24},
                  {91, 25, 83, 75, 49, 82, 48, 44, 61, 81, 53, 92, 50, 51, 89},
                  {95, 41,  2, 19, 44, 54, 24, 19, 72,  3, 24, 80, 78, 48,  3},
                  {50, 10,  5, 69, 45, 36, 85, 91, 23, 93, 49, 10, 72, 91, 49},
                  {49, 14, 17, 19, 31, 94, 20, 98, 12, 74, 63, 27, 91, 61, 17},
                  {34, 95, 65, 37, 51, 88, 23, 44, 30, 49, 68, 34, 90, 62, 98},
                  {91, 96, 74, 63, 52, 56, 18, 12, 32, 58, 40, 68, 34, 86, 72},
                  {37, 58, 65, 79, 82, 63, 23, 26, 43, 24, 37, 14, 70, 81, 51},
                  {12,  6, 46,  9, 80, 59, 44, 41, 51, 46, 99, 73, 20, 58, 48},
                  {79, 24, 55, 93, 65, 21, 32, 60,  9, 97,  4, 11,  4, 19,  6}};

double B[N][O] = {{69, 44, 44, 55 , 57, 59, 88, 64, 43, 29,  1, 20, 68, 85, 65 , 94, 15, 34, 95, 75},
                  {5 , 83,  2, 95 , 89, 23, 82,  4, 10, 68, 47, 74, 64, 84, 55 , 98, 59, 43, 33, 83},
                  {8 ,  9, 99, 42 , 67, 39, 27,  7, 27, 70, 43, 25, 95, 26, 73 , 20, 27, 28, 68, 79},
                  {53, 14, 17, 99 , 20, 59, 60, 32, 16,  7, 47, 92, 21, 62, 53 , 14,  5, 20, 44, 32},
                  {10, 18, 11, 31 , 37, 26,  3, 54, 29, 26, 78, 27, 71, 59, 100, 70, 76, 83, 84, 54},
                  {82, 40, 38, 71 , 47, 30, 43, 66, 45, 23, 33, 77, 24, 55, 22 , 10, 25, 43, 77, 9} ,
                  {82, 84, 20, 67 , 99, 62, 32, 41, 53, 67, 79, 19, 12, 87, 11 , 53, 45, 89, 17, 12},
                  {73, 81, 49, 54 , 16, 27, 17, 82, 46, 85, 48, 29, 61, 27, 11 , 54, 69, 40, 87, 14},
                  {15,  7, 34, 70 , 86, 83, 18, 72, 88, 35,  4, 10, 46, 32,  7 , 87, 36, 77, 99, 68},
                  {66, 40, 96, 67 , 65, 99, 43, 97, 52, 79, 18, 58, 46, 12, 41 , 49, 74, 40, 52, 50},
                  {52, 53, 93, 18 , 38, 74, 10, 54, 95, 68, 73, 69, 67, 94, 45 , 40, 40, 81, 89, 19},
                  {98, 42,  6, 13 , 20, 35, 60, 33, 64,  1, 48, 55, 78, 65, 37 , 68, 69, 76, 59, 50},
                  {65, 66, 74, 100, 43, 59, 48, 11, 96, 61, 16, 43, 36, 48, 77 , 75, 71, 38, 16, 15},
                  {81, 63, 27, 18 , 49, 11, 70, 62, 25, 39, 35, 65, 67, 64, 63 , 53, 45, 22, 20,  6},
                  {46, 30, 43,  4 , 13, 91, 70, 78, 68, 92, 61, 65, 42, 55, 78 , 35,  2, 80, 41, 86}};

double C[M][O] = {{40883, 34985, 28951, 34569, 30769, 30969, 28486, 35023, 36494, 34477, 33073, 34763, 40901, 39828, 35431, 39626, 37608, 38498, 41389, 25829},
                  {54913, 39157, 44552, 49345, 45767, 53338, 45587, 51340, 49913, 46247, 38793, 47745, 52169, 53853, 48582, 50104, 39107, 50982, 59353, 44948},
                  {35468, 27892, 21375, 34306, 31068, 28764, 30240, 28827, 33489, 22800, 20068, 26704, 32988, 37693, 29575, 40482, 28076, 32247, 37736, 25928},
                  {48528, 39655, 36129, 43188, 36960, 42223, 34204, 45145, 39779, 42334, 32908, 38205, 36740, 43068, 36698, 40811, 35909, 39016, 41415, 25716},
                  {44030, 35549, 35950, 38436, 30570, 34025, 28976, 39097, 37741, 36405, 26038, 34713, 35277, 36502, 31797, 35725, 34014, 32638, 41426, 21176},
                  {44058, 40406, 40071, 46591, 41703, 43962, 41065, 41493, 44119, 47389, 37030, 46579, 46389, 49720, 46931, 45878, 37350, 44611, 47966, 38824},
                  {43694, 36522, 34959, 43878, 42493, 41894, 45244, 40624, 37707, 40196, 33950, 44892, 48803, 50663, 47268, 47604, 34496, 41496, 48619, 42805},
                  {36302, 31230, 31403, 42184, 36480, 35698, 34256, 34898, 34474, 35504, 31854, 38916, 40000, 43012, 42591, 39238, 31250, 36608, 42172, 32336},
                  {38251, 29307, 32163, 28503, 32149, 35710, 24858, 38231, 38746, 34031, 33367, 33164, 39295, 39725, 33515, 35367, 32548, 42077, 44447, 27348},
                  {30214, 23081, 26766, 35142, 28336, 30791, 26102, 31967, 22083, 27639, 22811, 27401, 30920, 29602, 29973, 29837, 25168, 25447, 36600, 26939}};

void test_mean()
{
  double v[] = {0.7943, 0.3112, 0.5285, 0.1656, 0.6020, 0.2630, 0.6541, 0.6892, 0.7482, 0.4505};
  double mean = chem_mean(v, 10);
  double true_mean = 0.52066;
  if (fabs(mean-true_mean)>EPS) {
    printf("chem_mean: expected %.10g, got %.10g\n", true_mean, mean);
    exit(1);
  }
}

void test_matrix_multiply()
{
  double **c = chem_new_matrix(M,O);
  double **a = chem_new_matrix(M,N);
  double **b = chem_new_matrix(N,O);
  int i,j;
  for (i=0;i<M;i++)
    for (j=0;j<N;j++)
      a[i][j] = A[i][j];
  for (i=0;i<N;i++)
    for (j=0;j<O;j++)
    b[i][j] = B[i][j];
  chem_matrix_multiply(c, a, b, M, N, O);
  for (i=0;i<M;i++) {
    for (j=0;j<O;j++) {
      if (c[i][j] != C[i][j]) {
        printf("chem_matrix_multiply: c[%d][%d] (%.1g) != C[%d][%d] (%.1g)\n", i,j,c[i][j],i,j,C[i][j]);
        exit(1);
      }
    }
  }
  chem_kill_matrix(a);
  chem_kill_matrix(b);
  chem_kill_matrix(c);
}

double root_test_function(double x)
{
  return x-cos(x);
}

double root_test_function_derivative(double x)
{
  return 1+sin(x);
}

double integrate_test_function(double x)
{
  return x*x - cos(x);
}

void test_root()
{
  double expected = 0.73908513;
  double actual = chem_root(root_test_function, root_test_function_derivative, 0);
  if (fabs(expected-actual)>EPS) {
    printf("chem_root: expected %.8g, actual %.8g\n", expected, actual);
    exit(1);
  }
}

#define RAND_N 967
void test_random()
{
  int counts[RAND_N] = {0};
  int i;
  srand(1222);
  for (i=0; i<RAND_N*10000; i++)
    counts[chem_random(RAND_N)]++;
  for (i=0; i<RAND_N; i++)
    if (abs(counts[i]-10000)> 40) {
      printf("chem_random: %d generated %d times instead of %d\n", i, counts[i], 10000);
      exit(1);
    }
}

int main()
{
  test_matrix_multiply();
  test_mean();
  test_root();
  test_random();
  printf("All tests succesfully passed!\n");
  return 0;
}
